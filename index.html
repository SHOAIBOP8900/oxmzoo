<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Precision Locator Tool">
  <title>Taitan Locator Tool</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            mono: ['Ubuntu Mono', 'monospace'],
            sans: ['Inter', 'sans-serif']
          },
          animation: {
            'spin-slow': 'spin 3s linear infinite',
          }
        }
      }
    };
  </script>
  <style>
    ::-webkit-scrollbar { display: none !important; }
    .fade-in { animation: fadeIn 0.5s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
    #notification-container { position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
    .toast { color: #1f2937; padding: 1rem 1.5rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); font-weight: 600; font-size: 0.875rem; background: #fff; pointer-events: auto; }
    .toast.success { border-left: 4px solid #10b981; }
    .toast.error { border-left: 4px solid #ef4444; }
    #earth-container { position: fixed; top: 8px; right: 8px; width: 70px; height: 70px; border-radius: 50%; overflow: hidden; z-index: 5000; box-shadow: 0 0 15px rgba(0,0,0,0.5); background: #000; }
    #earthCanvas { width: 100%; height: 100%; }
    #map { height: 400px; width: 100%; z-index: 1; border-radius: 0.5rem; }
    .header-content { padding-right: 80px; } 
    .modal-overlay { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased font-mono min-h-screen relative flex flex-col">

  <div id="tgModal" class="fixed inset-0 z-[9999] flex items-center justify-center modal-overlay hidden fade-in">
    <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full mx-4 text-center relative border border-gray-200">
        <button id="closeModal" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
        </button>
        <div class="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
            <i class="fab fa-telegram-plane"></i>
        </div>
        <h2 class="text-xl font-bold text-slate-900 mb-2 font-sans">Join Our Community</h2>
        <p class="text-gray-600 mb-6 font-sans text-sm">Get latest updates, tools and premium support directly on Telegram.</p>
        <div class="flex gap-3">
            <button onclick="window.open('https://t.me/oxmzoo', '_blank')" class="flex-1 bg-blue-600 text-white py-2.5 rounded-lg font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 font-sans">
                Join Now
            </button>
            <button id="skipBtn" class="px-4 py-2.5 border border-gray-300 rounded-lg font-bold text-gray-600 hover:bg-gray-50 font-sans">
                Close
            </button>
        </div>
    </div>
  </div>

  <div id="earth-container">
      <canvas id="earthCanvas"></canvas>
  </div>

  <header class="sticky top-0 z-40 bg-white/90 backdrop-blur-md border-b border-gray-200 py-7 shadow-sm">
    <div class="max-w-2xl mx-auto px-10 header-content flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <i class="fas fa-crosshairs text-indigo-600 text-xl"></i>
        <h1 class="text-xl font-bold text-slate-900 tracking-tight">Taitan Locator</h1>
      </div>
    </div>
  </header>

  <main class="max-w-2xl mx-auto px-4 py-8 sm:px-6 flex-grow w-full">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6">
      <label for="q" class="block text-sm font-bold text-slate-700 mb-2">Search Number or Address</label>
      <div class="relative">
        <input type="text" id="q" placeholder="Enter Mobile Number (e.g. 9876543210)" 
               class="w-full p-4 pr-12 border border-gray-200 rounded-lg focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all font-sans text-lg">
        <button id="clearBtn" class="absolute right-4 top-4 text-gray-400 hover:text-gray-600 hidden">
            <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 gap-3 mt-4">
        <button id="searchBtn" class="w-full bg-slate-900 hover:bg-slate-800 text-white py-3.5 rounded-lg font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-slate-200">
          <i class="fas fa-search-location"></i> <span id="searchText">Locate Now</span>
        </button>
      </div>

      <div class="mt-3 flex justify-between items-center text-xs font-sans text-gray-500">
          <span id="statusText">System Ready</span>
          <span id="attemptsLog"></span>
      </div>
    </div>

    <div id="detailsCard" class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mb-6 hidden fade-in">
        <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
            <i class="fas fa-id-badge text-indigo-500"></i> Subscriber Details
        </h3>
        <div id="detailsBody" class="space-y-3 text-sm font-sans text-slate-600"></div>
    </div>

    <div class="bg-white p-2 rounded-xl shadow-sm border border-gray-100 mb-6">
        <div id="map"></div>
        <div class="flex justify-between items-center px-2 py-2">
            <div id="coords" class="text-xs text-slate-400 font-mono"></div>
            <button onclick="map.setView([20.5937, 78.9629], 4)" class="text-xs text-indigo-600 font-bold">Reset View</button>
        </div>
    </div>
  </main>

  <footer class="w-full py-6 text-center border-t border-gray-200 bg-white mt-auto">
    <p class="text-xs text-slate-400 font-sans">
        &copy; 2025 Taitan. All Rights Reserved.
    </p>
  </footer>

  <button onclick="window.open('https://t.me/oxmzoo', '_blank')"
          class="fixed bottom-6 right-6 z-50 bg-slate-900 text-white py-3 px-5 rounded-full text-sm font-bold shadow-xl hover:scale-105 transition-transform flex items-center gap-2">
    <i class="fab fa-telegram"></i> @oxmzoo
  </button>

  <div id="notification-container"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const qEl = document.getElementById('q');
    const searchBtn = document.getElementById('searchBtn');
    const statusEl = document.getElementById('statusText');
    const detailsCard = document.getElementById('detailsCard');
    const detailsBody = document.getElementById('detailsBody');
    const attemptsLog = document.getElementById('attemptsLog');

    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([20.5937, 78.9629], 4);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains:['mt0','mt1','mt2','mt3']
    }).addTo(map);

    let currentMarker = null;
    let currentCircle = null;

    function showToast(msg, type='success') {
        const container = document.getElementById('notification-container');
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        div.innerHTML = msg;
        container.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    function setStatus(msg) { statusEl.innerText = msg; }

    function extractPin(str) {
        const match = str.match(/\b\d{6}\b/);
        return match ? match[0] : null;
    }

    function sanitizeAddressForSearch(raw) {
        let clean = raw.replace(/\b(S\/O|D\/O|W\/O|C\/O)\s+[^,]+,/gi, ''); 
        clean = clean.replace(/[!@#$%^&*()]/g, '');
        clean = clean.replace(/\b\d{10}\b/g, '');
        return clean.trim();
    }

    async function searchNominatim(query) {
        if(!query) return null;
        try {
            const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&countrycodes=in`;
            const res = await fetch(url);
            const data = await res.json();
            return data.length > 0 ? data[0] : null;
        } catch(e) { return null; }
    }

    async function smartGeocode(rawAddress) {
        attemptsLog.innerText = "Analyzing Address...";
        const addressText = sanitizeAddressForSearch(rawAddress);
        const pin = extractPin(rawAddress);
        let result = null;

        if (addressText.length > 5) {
            attemptsLog.innerText = "Searching Exact Address...";
            result = await searchNominatim(addressText);
        }

        if (!result && addressText.includes(',')) {
            const parts = addressText.split(',');
            if (parts.length > 1) {
                const broaderArea = parts.slice(1).join(',').trim();
                attemptsLog.innerText = "Searching Area...";
                result = await searchNominatim(broaderArea);
            }
        }

        if (!result && pin) {
            attemptsLog.innerText = `Fallback to PIN: ${pin}...`;
            result = await searchNominatim(pin); 
            if(result) showToast("Exact address unclear. Showing PIN Area.", "success");
        } else if (result) {
            showToast("Found location via Address.", "success");
        }
        return result;
    }

    async function handleSearch() {
        const query = qEl.value.trim();
        if(!query) return showToast("Enter a number first", "error");

        searchBtn.disabled = true;
        searchBtn.innerHTML = `<i class="fas fa-circle-notch fa-spin"></i> Fetching...`;
        detailsCard.classList.add('hidden');
        attemptsLog.innerText = "";

        try {
            const isMobile = /^\d{10,12}$/.test(query.replace(/\D/g,''));
            let finalLocation = null;
            let addressToMap = query;

            if (isMobile) {
                setStatus("Fetching Subscriber Data...");
                const cleanNum = query.replace(/\D/g,'');
                
                const apiRes = await fetch(`/api/search?mobile=${cleanNum}`);
                const apiJson = await apiRes.json();

                if (!apiJson.data || apiJson.data.length === 0) {
                    throw new Error("Number not found in database");
                }

                const data = apiJson.data[0];
                
                detailsBody.innerHTML = `
                    <div class="flex justify-between border-b pb-2"><span>Mobile:</span> <span class="font-mono font-bold text-slate-800">${data.mobile || 'N/A'}</span></div>
                    <div class="flex justify-between border-b pb-2"><span>Name:</span> <span class="font-bold text-slate-800">${data.name || 'Unknown'}</span></div>
                    <div class="flex justify-between border-b pb-2"><span>Parent:</span> <span class="font-bold text-slate-800">${data.fname || 'N/A'}</span></div>
                    <div class="mt-2"><span class="block text-xs text-gray-400 uppercase">Registered Address</span>
                    <span class="block font-medium bg-slate-50 p-2 rounded border border-slate-200 mt-1">${data.address || 'Not Available'}</span></div>
                `;
                detailsCard.classList.remove('hidden');

                if(data.address) {
                    setStatus("Tracing Address...");
                    addressToMap = data.address;
                    finalLocation = await smartGeocode(addressToMap);
                } else {
                    showToast("Details found, but no address to map.", "error");
                }

            } else {
                setStatus("Searching Address...");
                finalLocation = await smartGeocode(query);
            }

            if (finalLocation) {
                const lat = parseFloat(finalLocation.lat);
                const lon = parseFloat(finalLocation.lon);

                if(currentMarker) map.removeLayer(currentMarker);
                if(currentCircle) map.removeLayer(currentCircle);

                currentMarker = L.marker([lat, lon]).addTo(map)
                    .bindPopup(`<b>Found Location</b><br>${finalLocation.display_name}`).openPopup();
                
                currentCircle = L.circle([lat, lon], {
                    color: 'indigo',
                    fillColor: '#4f46e5',
                    fillOpacity: 0.1,
                    radius: 1000 
                }).addTo(map);

                map.flyTo([lat, lon], 14, { duration: 2 }); 
                document.getElementById('coords').innerText = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                setStatus("Target Located Successfully");
                attemptsLog.innerText = "";
            } else {
                setStatus("Location not found on map");
                showToast("Could not pinpoint location on map", "error");
            }

        } catch (err) {
            console.error(err);
            showToast(err.message || "Search failed", "error");
            setStatus("Error");
        } finally {
            searchBtn.disabled = false;
            searchBtn.innerHTML = `<i class="fas fa-search-location"></i> Locate Now`;
        }
    }

    searchBtn.addEventListener('click', handleSearch);
    
    qEl.addEventListener('input', (e) => {
        document.getElementById('clearBtn').classList.toggle('hidden', e.target.value === '');
    });
    document.getElementById('clearBtn').addEventListener('click', () => {
        qEl.value = '';
        qEl.focus();
        document.getElementById('clearBtn').classList.add('hidden');
    });

    const modal = document.getElementById('tgModal');
    const closeModal = document.getElementById('closeModal');
    const skipBtn = document.getElementById('skipBtn');

    window.addEventListener('load', () => {
        setTimeout(() => {
            modal.classList.remove('hidden');
        }, 1500);
    });

    function hideModal() {
        modal.classList.add('hidden');
    }

    closeModal.addEventListener('click', hideModal);
    skipBtn.addEventListener('click', hideModal);

  </script>

  <script>
    (function() {
        const canvas = document.getElementById('earthCanvas');
        const width = 70; 
        const height = 70;
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        
        renderer.setSize(width, height);
        renderer.setPixelRatio(window.devicePixelRatio);
        camera.position.z = 3.5;

        const group = new THREE.Group();
        scene.add(group);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);
        const sunLight = new THREE.DirectionalLight(0xffffff, 1.5);
        sunLight.position.set(5, 3, 5);
        scene.add(sunLight);

        const texLoader = new THREE.TextureLoader();
        texLoader.crossOrigin = 'anonymous';
        
        const mapTex = texLoader.load('https://raw.githubusercontent.com/turban/webgl-earth/master/images/2_no_clouds_4k.jpg');
        const cloudTex = texLoader.load('https://raw.githubusercontent.com/turban/webgl-earth/master/images/fair_clouds_4k.png');

        const geometry = new THREE.SphereGeometry(1, 32, 32);
        const material = new THREE.MeshPhongMaterial({ 
            map: mapTex, 
            specular: new THREE.Color(0x333333), 
            shininess: 5 
        });
        const earth = new THREE.Mesh(geometry, material);
        group.add(earth);

        const atmGeometry = new THREE.SphereGeometry(1.1, 32, 32);
        const atmMaterial = new THREE.ShaderMaterial({
            vertexShader: `varying vec3 vNormal; void main(){ vNormal = normalize(normalMatrix * normal); gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
            fragmentShader: `varying vec3 vNormal; void main(){ float i = pow(0.6 - dot(vNormal, vec3(0,0,1.0)), 2.0); gl_FragColor = vec4(0.2, 0.5, 1.0, 1.0) * i; }`,
            blending: THREE.AdditiveBlending, side: THREE.BackSide, transparent: true
        });
        const atmosphere = new THREE.Mesh(atmGeometry, atmMaterial);
        group.add(atmosphere);

        const cloudGeom = new THREE.SphereGeometry(1.02, 32, 32);
        const cloudMat = new THREE.MeshPhongMaterial({ 
            map: cloudTex, transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending 
        });
        const clouds = new THREE.Mesh(cloudGeom, cloudMat);
        group.add(clouds);

        let rot = 0;
        function animate() {
            requestAnimationFrame(animate);
            rot += 0.005;
            earth.rotation.y = rot;
            clouds.rotation.y = rot * 1.1;
            renderer.render(scene, camera);
        }
        animate();
    })();
  </script>
</body>
</html>